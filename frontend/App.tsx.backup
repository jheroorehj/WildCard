
import React, { useState, useEffect, useRef } from 'react';
import { InvestmentFormData, AnalysisResult, Message, StockDetail } from './types';
import { DECISION_OPTIONS, TRADE_PATTERNS, TRADE_PERIODS, ICONS } from './constants';
import { analyzeInvestmentLoss, chatWithAnalyst } from './services/geminiService';

type ViewType = 'splash' | 'home' | 'form' | 'analysis';

// --- Mini Calendar Component ---
const DateRangePicker: React.FC<{ 
  value: string, 
  onChange: (val: string) => void 
}> = ({ value, onChange }) => {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [range, setRange] = useState<{ start?: Date, end?: Date }>({});
  const [mode, setMode] = useState<'day' | 'yearMonth'>('day');

  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  const daysInMonth = (year: number, month: number) => new Date(year, month + 1, 0).getDate();
  const firstDayOfMonth = (year: number, month: number) => new Date(year, month, 1).getDay();

  const days = daysInMonth(year, month);
  const startDay = firstDayOfMonth(year, month);

  const formatDate = (date: Date) => {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  };

  const handleDateClick = (day: number) => {
    const selected = new Date(year, month, day);
    if (!range.start || (range.start && range.end)) {
      setRange({ start: selected });
    } else if (selected < range.start) {
      setRange({ start: selected });
    } else {
      const newRange = { ...range, end: selected };
      setRange(newRange);
      if (newRange.start && newRange.end) {
        const startStr = formatDate(newRange.start);
        const endStr = formatDate(newRange.end);
        onChange(`${startStr} ~ ${endStr}`);
      }
    }
  };

  const isSelected = (day: number) => {
    const d = new Date(year, month, day);
    if (range.start && d.getTime() === range.start.getTime()) return true;
    if (range.end && d.getTime() === range.end.getTime()) return true;
    return false;
  };

  const isInRange = (day: number) => {
    const d = new Date(year, month, day);
    return range.start && range.end && d > range.start && d < range.end;
  };

  if (mode === 'yearMonth') {
    return (
      <div className="bg-slate-900 border border-slate-800 rounded-2xl p-4 mt-2 select-none animate-in fade-in zoom-in-95 duration-200">
        <div className="flex justify-between items-center mb-4 px-1">
          <button onClick={() => setCurrentDate(new Date(year - 1, month))} className="p-1 hover:bg-slate-800 rounded-md transition-colors text-slate-400">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m15 18-6-6 6-6"/></svg>
          </button>
          <button onClick={() => setMode('day')} className="px-3 py-1 bg-blue-600/10 rounded-full text-[11px] font-black text-blue-400 border border-blue-500/20">
            {year}년
          </button>
          <button onClick={() => setCurrentDate(new Date(year + 1, month))} className="p-1 hover:bg-slate-800 rounded-md transition-colors text-slate-400">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m9 6 6 6-6 6"/></svg>
          </button>
        </div>
        <div className="grid grid-cols-3 gap-2">
          {Array.from({ length: 12 }).map((_, i) => (
            <button
              key={i}
              onClick={() => {
                setCurrentDate(new Date(year, i));
                setMode('day');
              }}
              className={`py-2 text-[10px] font-bold rounded-lg transition-all ${
                i === month ? 'bg-blue-600 text-white' : 'bg-slate-800/50 text-slate-400 hover:bg-slate-800'
              }`}
            >
              {i + 1}월
            </button>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="bg-slate-900 border border-slate-800 rounded-2xl p-4 mt-2 select-none animate-in fade-in zoom-in-95 duration-200">
      <div className="flex justify-between items-center mb-4 px-1">
        <button onClick={() => setCurrentDate(new Date(year, month - 1))} className="p-1 hover:bg-slate-800 rounded-md transition-colors text-slate-400">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m15 18-6-6 6-6"/></svg>
        </button>
        <button 
          onClick={() => setMode('yearMonth')}
          className="px-3 py-1 hover:bg-slate-800 rounded-lg transition-all text-[11px] font-black text-white flex items-center gap-1 group"
        >
          {year}년 {month + 1}월
          <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" className="text-blue-500 opacity-50 group-hover:opacity-100 transition-transform"><path d="m6 9 6 6 6-6"/></svg>
        </button>
        <button onClick={() => setCurrentDate(new Date(year, month + 1))} className="p-1 hover:bg-slate-800 rounded-md transition-colors text-slate-400">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m9 6 6 6-6 6"/></svg>
        </button>
      </div>
      <div className="grid grid-cols-7 gap-1 text-center">
        {['일', '월', '화', '수', '목', '금', '토'].map(d => (
          <span key={d} className="text-[9px] font-bold text-slate-600 mb-1">{d}</span>
        ))}
        {Array.from({ length: startDay }).map((_, i) => <div key={`empty-${i}`} />)}
        {Array.from({ length: days }).map((_, i) => {
          const day = i + 1;
          const selected = isSelected(day);
          const inRange = isInRange(day);
          return (
            <button
              key={day}
              onClick={() => handleDateClick(day)}
              className={`text-[10px] h-7 w-7 rounded-lg flex items-center justify-center transition-all ${
                selected ? 'bg-blue-600 text-white font-bold' : 
                inRange ? 'bg-blue-600/20 text-blue-300' : 'hover:bg-slate-800 text-slate-400'
              }`}
            >
              {day}
            </button>
          );
        })}
      </div>
      <div className="mt-3 flex justify-between items-center border-t border-slate-800 pt-3">
        <p className="text-[9px] text-slate-500 font-medium">시작일과 종료일을 선택하세요</p>
        <button onClick={() => { setRange({}); onChange(''); }} className="text-[9px] font-bold text-red-400/70 hover:text-red-400 transition-colors">초기화</button>
      </div>
    </div>
  );
};

const App: React.FC = () => {
  const [view, setView] = useState<ViewType>('splash');
  const [step, setStep] = useState<number>(1);
  const [stockInput, setStockInput] = useState('');
  const [formData, setFormData] = useState<InvestmentFormData>({
    stocks: [],
    decisionBasis: []
  });
  const [loading, setLoading] = useState<boolean>(false);
  const [analysis, setAnalysis] = useState<AnalysisResult | null>(null);
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState('');
  const scrollRef = useRef<HTMLDivElement>(null);

  const [showCustomPeriod, setShowCustomPeriod] = useState<Record<number, boolean>>({});

  useEffect(() => {
    const timer = setTimeout(() => {
      setView('home');
    }, 2500);
    return () => clearTimeout(timer);
  }, []);

  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages]);

  const startAnalysis = () => {
    setFormData({ stocks: [], decisionBasis: [] });
    setStockInput('');
    setStep(1);
    setShowCustomPeriod({});
    setView('form');
  };

  const nextStep = () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    setStep(prev => prev + 1);
  };
  const prevStep = () => {
    if (step > 1) setStep(prev => prev - 1);
    else setView('home');
  };
  
  const handleAnalysis = async () => {
    setLoading(true);
    try {
      const result = await analyzeInvestmentLoss(formData);
      setAnalysis(result);
      setMessages([]); 
      setView('analysis');
    } catch (error) {
      console.error(error);
      alert("분석 중 오류가 발생했습니다.");
    } finally {
      setLoading(false);
    }
  };

  const addStock = () => {
    const name = stockInput.trim();
    if (name && !formData.stocks.find(s => s.name === name)) {
      const newStock: StockDetail = {
        name,
        status: 'holding',
        period: TRADE_PERIODS[0],
        customPeriod: '',
        patterns: []
      };
      setFormData(prev => ({ ...prev, stocks: [...prev.stocks, newStock] }));
      setStockInput('');
    }
  };

  const removeStock = (name: string) => {
    setFormData(prev => ({ ...prev, stocks: prev.stocks.filter(s => s.name !== name) }));
  };

  const updateStockDetail = (index: number, updates: Partial<StockDetail>) => {
    setFormData(prev => {
      const newStocks = [...prev.stocks];
      newStocks[index] = { ...newStocks[index], ...updates };
      return { ...prev, stocks: newStocks };
    });
  };

  const toggleStockPattern = (index: number, pattern: string) => {
    const stock = formData.stocks[index];
    const newPatterns = stock.patterns.includes(pattern)
      ? stock.patterns.filter(p => p !== pattern)
      : [...stock.patterns, pattern];
    updateStockDetail(index, { patterns: newPatterns });
  };

  const toggleDecisionBasis = (option: string) => {
    setFormData(prev => ({
      ...prev,
      decisionBasis: prev.decisionBasis.includes(option)
        ? prev.decisionBasis.filter(o => o !== option)
        : [...prev.decisionBasis, option]
    }));
  };

  const handleSendMessage = async (msgOverride?: string) => {
    const text = msgOverride || input;
    if (!text.trim()) return;

    const currentMessages = [...messages, { role: 'user' as const, content: text }];
    setMessages(currentMessages);
    setInput('');

    try {
      const response = await chatWithAnalyst(
        currentMessages.map(m => ({ role: m.role, content: m.content })),
        text
      );
      setMessages(prev => [...prev, { role: 'assistant' as const, content: response }]);
    } catch (error) {
      console.error(error);
    }
  };

  const toggleCustomInput = (index: number) => {
    setShowCustomPeriod(prev => ({ ...prev, [index]: !prev[index] }));
  };

  const isNextDisabled = (step === 1 && formData.stocks.length === 0) || 
                       (step === 2 && formData.stocks.some(s => s.patterns.length === 0)) || 
                       (step === 3 && formData.decisionBasis.length === 0);

  if (view === 'splash') {
    return (
      <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-6 transition-opacity duration-700">
        <div className="relative flex items-center justify-center w-40 h-40">
          <div className="absolute inset-0 border-2 border-blue-500/20 rounded-[3rem] animate-[spin_10s_linear_infinite]"></div>
          <div className="absolute inset-4 border border-blue-400/10 rounded-[2.5rem] animate-[spin_15s_linear_infinite_reverse]"></div>
          <div className="z-10 w-28 h-28 bg-blue-600 rounded-[2.2rem] flex items-center justify-center shadow-[0_0_60px_rgba(37,99,235,0.5)] animate-pulse overflow-hidden">
            <span className="text-white text-6xl font-black leading-none select-none tracking-tighter">W</span>
          </div>
        </div>
        <div className="mt-12 text-center space-y-3">
          <h1 className="text-4xl font-black tracking-tighter text-white">WILDCARD</h1>
          <p className="text-blue-400 font-bold tracking-[0.3em] text-[10px] uppercase opacity-80">Loss Analysis Engine</p>
        </div>
        <div className="absolute bottom-12 text-center">
            <p className="text-slate-500 text-sm font-medium animate-bounce">투자 패턴 분석의 새로운 기준</p>
        </div>
      </div>
    );
  }

  if (loading) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-slate-950 text-white p-6">
        <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-8"></div>
        <h2 className="text-2xl font-bold mb-4 animate-pulse text-center">노트를<br/>정리하고 있습니다</h2>
        <p className="text-slate-400 text-center max-w-xs text-sm">기록된 매매 데이터와 시장 상황을 <br/>정밀하게 대조하고 있습니다.</p>
      </div>
    );
  }

  if (view === 'home') {
    return (
      <div className="h-screen max-w-md mx-auto bg-slate-950 text-white flex flex-col relative overflow-hidden">
        <div className="absolute top-[-50px] left-[-50px] w-64 h-64 bg-blue-600/10 blur-[100px] rounded-full pointer-events-none"></div>
        <header className="px-6 pt-6 pb-2 flex justify-between items-center shrink-0 z-20">
          <div className="flex items-center gap-2 group cursor-pointer">
            <div className="w-6 h-6 bg-blue-600 rounded-lg flex items-center justify-center font-black text-[11px] shadow-lg shadow-blue-600/20">W</div>
            <span className="font-black tracking-tighter text-lg leading-none">WILDCARD</span>
          </div>
          <button className="p-2 text-slate-400 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
          </button>
        </header>
        <main className="flex-1 px-6 overflow-y-auto pb-8">
          <div className="mt-4 space-y-1">
            <h2 className="text-2xl font-bold leading-tight">당신의 <span className="text-blue-500">선택</span>이<br/>최고의 <span className="text-purple-400">자산</span>이 되도록</h2>
            <p className="text-slate-400 text-xs">와일드카드가 당신의 투자 여정을 함께 기록합니다.</p>
          </div>
          <button onClick={startAnalysis} className="mt-6 group relative w-full bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl p-5 flex flex-col justify-between overflow-hidden shadow-2xl shadow-blue-900/40 transition-transform active:scale-[0.98]">
            <div className="absolute top-0 right-0 w-24 h-24 bg-white/10 blur-[30px] rounded-full -mr-12 -mt-12 group-hover:scale-110 transition-transform duration-500"></div>
            <div className="relative z-10 text-left mb-8">
              <span className="bg-white/20 px-2 py-0.5 rounded-full text-[9px] font-bold uppercase tracking-wider">AI : WILDCARD</span>
              <h3 className="text-xl font-black mt-3 tracking-tight">AI 투자 결정 복기 시작</h3>
            </div>
            <div className="relative z-10 flex justify-between items-center">
              <p className="text-blue-100 text-[10px] font-medium opacity-80">포트폴리오 중심의 다중 분석 지원</p>
              <div className="bg-white text-blue-600 p-1.5 rounded-full shadow-lg">{ICONS.ArrowRight}</div>
            </div>
          </button>
          <div className="mt-6 grid grid-cols-2 gap-3">
            <div className="bg-slate-900/50 rounded-2xl p-4">
              <p className="text-slate-500 text-[9px] font-bold uppercase tracking-wider mb-1">나의 분석 노트</p>
              <div className="flex items-baseline gap-1"><span className="text-xl font-bold">12</span><span className="text-slate-400 text-[10px]">건</span></div>
            </div>
            <div className="bg-slate-900/50 rounded-2xl p-4">
              <p className="text-slate-500 text-[9px] font-bold uppercase tracking-wider mb-1">학습 성취도</p>
              <div className="flex items-baseline gap-1"><span className="text-xl font-bold text-green-400">84%</span></div>
            </div>
          </div>
          <div className="mt-8">
            <h4 className="text-xs font-bold text-slate-300 mb-4 flex items-center gap-2"><span className="w-1 h-3 bg-blue-500 rounded-full"></span>최근 복기 노트</h4>
            <div className="space-y-2.5">
              {[{ name: '삼성전자 외 2건', date: '2025.02.10', type: '포트폴리오 분석' }, { name: '테슬라', date: '2025.01.24', type: '매매 패턴 분석' }, { name: '엔비디아', date: '2025.01.05', type: '추격 매수 분석' }].map((item, i) => (
                <div key={i} className="bg-slate-900/30 rounded-xl p-3.5 flex justify-between items-center group hover:bg-slate-900/50 transition-colors cursor-pointer">
                  <div><h5 className="font-bold text-sm text-slate-200">{item.name}</h5><p className="text-[9px] text-slate-500">{item.date} • {item.type}</p></div>
                  <div className="text-slate-600 group-hover:text-slate-400 transition-colors">{ICONS.ArrowRight}</div>
                </div>
              ))}
            </div>
          </div>
        </main>
      </div>
    );
  }

  if (view === 'form') {
    const nextButton = (
      <button 
        onClick={step === 3 ? handleAnalysis : nextStep} 
        disabled={isNextDisabled} 
        className="w-full bg-blue-600 disabled:bg-slate-800 disabled:opacity-50 text-white p-5 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 shadow-xl shadow-blue-900/20"
      >
        {step === 3 ? '복기 노트 생성하기' : '다음으로 넘어가기'} {ICONS.ArrowRight}
      </button>
    );

    return (
      <div className="h-screen max-w-md mx-auto bg-slate-950 flex flex-col shadow-2xl relative overflow-hidden">
        <div className="absolute top-0 right-0 w-64 h-64 bg-blue-600/10 blur-[100px] rounded-full -mr-32 -mt-32"></div>
        
        {/* Fixed Header */}
        <div className="p-8 pb-4 shrink-0 z-20">
          <div className="flex items-center">
            <button onClick={prevStep} className="p-2 -ml-2 text-slate-400 hover:text-white transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m15 18-6-6 6-6"/></svg>
            </button>
            <div className="h-1 flex-1 bg-slate-800 mx-4 rounded-full overflow-hidden">
              <div className="h-full bg-blue-500 transition-all duration-500" style={{ width: `${(step / 3) * 100}%` }}></div>
            </div>
            <span className="text-slate-500 font-mono text-xs">{step}/3</span>
          </div>
        </div>

        {step === 2 ? (
          /* Step 2 Only: Integrated Scroll Layout (Title + Content + Button all scroll together) */
          <div className="flex-1 overflow-y-auto px-8 pb-8 custom-scrollbar relative z-10">
            <div className="step-transition animate-in fade-in slide-in-from-bottom-4 flex flex-col">
              <h1 className="text-2xl font-bold mb-1 leading-tight">종목별 <span className="text-blue-400">거래 상황</span>을<br/>알려주세요.</h1>
              <p className="text-slate-500 text-[11px] mb-6 font-medium">기간을 입력하면 시장 상황과 연동하여 더 좋은 결과를 낼 수 있습니다.</p>
              
              <div className="space-y-4 mb-8">
                {formData.stocks.map((stock, idx) => (
                  <div key={stock.name} className="bg-slate-900/40 rounded-3xl p-4 border border-slate-800 space-y-4 shadow-sm">
                    <div className="flex justify-between items-center">
                      <h3 className="text-base font-black text-white">{stock.name}</h3>
                      <div className="flex bg-slate-800 p-0.5 rounded-lg shrink-0">
                        <button onClick={() => updateStockDetail(idx, {status: 'holding'})} className={`px-2.5 py-1 text-[9px] font-bold rounded-md transition-all ${stock.status === 'holding' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500'}`}>보유 중</button>
                        <button onClick={() => updateStockDetail(idx, {status: 'sold'})} className={`px-2.5 py-1 text-[9px] font-bold rounded-md transition-all ${stock.status === 'sold' ? 'bg-slate-700 text-white shadow-lg' : 'text-slate-500'}`}>매도 완료</button>
                      </div>
                    </div>

                    <div className="space-y-2.5">
                      <div className="flex justify-between items-center">
                        <p className="text-[9px] font-bold text-slate-500 uppercase tracking-widest flex items-center gap-1">언제 거래했나요? {ICONS.Calendar}</p>
                        <button onClick={() => toggleCustomInput(idx)} className={`flex items-center gap-1 px-2 py-0.5 rounded-md text-[8px] font-black uppercase transition-all border ${showCustomPeriod[idx] ? 'bg-blue-600 text-white border-blue-400' : 'bg-slate-800 text-slate-400 border-slate-700'}`}>
                          {ICONS.Edit} 직접 입력
                        </button>
                      </div>
                      <div className="flex flex-wrap gap-1">
                        {TRADE_PERIODS.map(p => (
                          <button key={p} onClick={() => updateStockDetail(idx, {period: p})} className={`px-2 py-1 rounded-full text-[9px] font-medium border transition-all ${stock.period === p ? 'bg-blue-600/20 border-blue-500 text-blue-400' : 'bg-slate-900/50 border-slate-800 text-slate-500'}`}>{p}</button>
                        ))}
                      </div>
                      {showCustomPeriod[idx] && (
                        <div className="space-y-2">
                          <input 
                            type="text" 
                            placeholder="분석 기간 (예: 2024년 여름 등)" 
                            className="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-3 py-2 text-[10px] text-white placeholder:text-slate-700 focus:border-blue-500 outline-none" 
                            value={stock.customPeriod} 
                            onChange={(e) => updateStockDetail(idx, { customPeriod: e.target.value })} 
                          />
                          <DateRangePicker value={stock.customPeriod || ''} onChange={(val) => updateStockDetail(idx, { customPeriod: val })} />
                        </div>
                      )}
                    </div>

                    <div className="space-y-2">
                      <p className="text-[9px] font-bold text-slate-500 uppercase tracking-widest">매매 패턴 (중복 가능)</p>
                      <div className="flex flex-wrap gap-1">
                        {TRADE_PATTERNS.map(p => (
                          <button key={p} onClick={() => toggleStockPattern(idx, p)} className={`px-2 py-1 rounded-full text-[9px] font-medium border transition-all ${stock.patterns.includes(p) ? 'bg-emerald-600/20 border-emerald-500 text-emerald-400' : 'bg-slate-900/50 border-slate-800 text-slate-500'}`}>{p}</button>
                        ))}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
              {nextButton}
            </div>
          </div>
        ) : (
          /* Step 1 and 3: Standard Layout (Fixed Button at bottom) */
          <>
            <div className="flex-1 flex flex-col px-8 overflow-hidden relative z-10">
              {step === 1 && (
                <div className="step-transition animate-in fade-in slide-in-from-bottom-4 flex flex-col h-full">
                  <h1 className="text-2xl font-bold mb-3 leading-tight shrink-0">이번에 복기할 <br/><span className="text-blue-400">종목은 무엇인가요?</span></h1>
                  <p className="text-slate-500 text-xs mb-6 shrink-0">투자 판단을 되돌아보고 싶은 모든 대상을 추가해주세요.</p>
                  
                  <div className="relative mb-4 h-[56px] bg-slate-900/60 rounded-2xl border border-slate-800 focus-within:border-blue-500 transition-all flex items-center shrink-0">
                    <input type="text" autoFocus placeholder="종목명 입력 (예: 삼성전자)" className="flex-1 h-full bg-transparent pl-5 pr-14 text-base font-bold text-white outline-none placeholder:text-slate-700" value={stockInput} onChange={e => setStockInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && addStock()} />
                    <div className="absolute right-2.5 w-9 h-9 flex items-center justify-center">
                      <button onClick={addStock} className="w-full h-full flex items-center justify-center bg-blue-600 text-white rounded-lg active:scale-95 transition-all shadow-lg">{ICONS.Plus}</button>
                    </div>
                  </div>

                  {/* Dotted Separator 복구 */}
                  <div className="my-2 border-t-2 border-dotted border-slate-800/60 shrink-0"></div>

                  <div className="flex-1 overflow-y-auto space-y-2 mb-4 custom-scrollbar">
                    {formData.stocks.map(stock => (
                      <div key={stock.name} className="relative h-[56px] bg-slate-900/60 rounded-2xl flex items-center border border-slate-800 animate-in slide-in-from-top-2 shrink-0">
                        <span className="flex-1 pl-5 text-base font-bold text-white truncate">{stock.name}</span>
                        <button onClick={() => removeStock(stock.name)} className="absolute right-2.5 w-9 h-9 flex items-center justify-center bg-slate-800/80 text-slate-500 rounded-lg">{ICONS.Minus}</button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {step === 3 && (
                <div className="step-transition animate-in fade-in slide-in-from-bottom-4 flex flex-col h-full">
                  <h1 className="text-2xl font-bold mb-6 leading-tight shrink-0">투자 결정의 <span className="text-blue-400">핵심 근거</span>는<br/>무엇이었나요?</h1>
                  <div className="flex-1 overflow-y-auto space-y-3 mb-4 custom-scrollbar pr-1">
                    {DECISION_OPTIONS.map(option => (
                      <button key={option} onClick={() => toggleDecisionBasis(option)} className={`w-full p-4 rounded-2xl text-left transition-all border ${formData.decisionBasis.includes(option) ? 'bg-blue-600 border-blue-400 text-white shadow-lg' : 'bg-slate-900 border-slate-800 text-slate-400 hover:border-slate-700'}`}>
                        <div className="flex justify-between items-center"><span className="font-medium text-sm">{option}</span>{formData.decisionBasis.includes(option) && ICONS.Check}</div>
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </div>
            {/* Fixed Footer for Step 1 and 3 */}
            <div className="p-8 pt-2 shrink-0 relative z-20">
              {nextButton}
            </div>
          </>
        )}
      </div>
    );
  }

  return (
    <div className="h-screen max-w-md mx-auto bg-slate-950 flex flex-col shadow-2xl relative overflow-hidden">
      {/* Note Background Grid */}
      <div className="absolute inset-0 opacity-[0.03] pointer-events-none z-0" style={{ backgroundImage: 'radial-gradient(#ffffff 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>
      <div className="absolute inset-0 opacity-[0.05] pointer-events-none z-0" style={{ backgroundImage: 'linear-gradient(#ffffff 1px, transparent 1px), linear-gradient(90deg, #ffffff 1px, transparent 1px)', backgroundSize: '100px 100px' }}></div>
      
      <header className="px-5 py-4 flex items-center gap-3 shrink-0 bg-slate-950/80 backdrop-blur-md sticky top-0 z-20 border-b border-white/5">
        <button onClick={() => setView('home')} className="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-white font-black text-xs shadow-lg shadow-blue-600/30">W</button>
        <div>
          <h1 className="text-sm font-bold text-white leading-tight">{formData.stocks.length > 1 ? `${formData.stocks[0].name} 외 ${formData.stocks.length - 1}건` : formData.stocks[0]?.name} 투자 복기 노트</h1>
          <div className="flex items-center gap-1.5 mt-0.5"><span className="w-1 h-1 bg-blue-500 rounded-full animate-pulse"></span><span className="text-[9px] text-blue-500 font-bold uppercase tracking-widest">실시간 인사이트 메모 중</span></div>
        </div>
      </header>

      <div ref={scrollRef} className="flex-1 overflow-y-auto px-5 space-y-6 pt-6 pb-20 scroll-smooth relative z-10">
        {analysis && (
          <div className="space-y-8">
            {/* Binder Spiral Visual Effect on the left */}
            <div className="absolute left-1 top-0 bottom-0 flex flex-col gap-8 opacity-20 pointer-events-none">
                {Array.from({length: 15}).map((_, i) => (
                    <div key={i} className="w-3 h-1.5 bg-slate-500 rounded-full"></div>
                ))}
            </div>

            {/* Entry 1: Loss Analysis */}
            <section className="relative ml-2 bg-slate-900/60 border border-white/10 rounded-2xl shadow-xl animate-in fade-in slide-in-from-bottom-4 overflow-hidden">
              <div className="absolute top-0 right-0 w-16 h-16 bg-rose-500/10 rounded-bl-full pointer-events-none"></div>
              <div className="px-5 py-3 border-b border-white/5 flex items-center justify-between">
                <span className="text-[10px] font-black text-rose-500/80 uppercase tracking-tighter">Psychology Record</span>
                <button onClick={() => handleSendMessage(`'${analysis.lossAnalysisTitle}' 노트의 심리 분석을 더 깊게 파헤쳐줘.`)} className="p-1 text-slate-500 hover:text-rose-400 transition-colors">{ICONS.Search}</button>
              </div>
              <div className="p-6">
                <h5 className="text-xl font-black text-white mb-4 leading-tight tracking-tight relative inline-block">
                  <span className="relative z-10">{analysis.lossAnalysisTitle}</span>
                  <div className="absolute bottom-1 left-0 right-0 h-3 bg-rose-500/20 -rotate-1 z-0 rounded-full"></div>
                </h5>
                <p className="text-slate-300 leading-relaxed text-sm font-medium opacity-90">{analysis.lossAnalysis}</p>
              </div>
            </section>

            {/* Entry 2: Market Analysis */}
            <section className="relative ml-2 bg-slate-900/60 border border-white/10 rounded-2xl shadow-xl animate-in fade-in slide-in-from-bottom-4 delay-75 overflow-hidden">
              <div className="absolute top-0 right-0 w-16 h-16 bg-blue-500/10 rounded-bl-full pointer-events-none"></div>
              <div className="px-5 py-3 border-b border-white/5 flex items-center justify-between">
                <span className="text-[10px] font-black text-blue-500/80 uppercase tracking-tighter">Market Environment</span>
                <button onClick={() => handleSendMessage(`'${analysis.marketAnalysisTitle}'에 대한 당시 뉴스나 데이터를 메모해줘.`)} className="p-1 text-slate-500 hover:text-blue-400 transition-colors">{ICONS.Search}</button>
              </div>
              <div className="p-6">
                <h5 className="text-xl font-black text-white mb-4 leading-tight tracking-tight relative inline-block">
                  <span className="relative z-10">{analysis.marketAnalysisTitle}</span>
                  <div className="absolute bottom-1 left-0 right-0 h-3 bg-blue-500/20 rotate-1 z-0 rounded-full"></div>
                </h5>
                <p className="text-slate-300 leading-relaxed text-sm font-medium opacity-90">{analysis.marketAnalysis}</p>
              </div>
            </section>

            {/* Entry 3: Pattern Analysis */}
            <section className="relative ml-2 bg-slate-900/60 border border-white/10 rounded-2xl shadow-xl animate-in fade-in slide-in-from-bottom-4 delay-100 overflow-hidden">
              <div className="absolute top-0 right-0 w-16 h-16 bg-emerald-500/10 rounded-bl-full pointer-events-none"></div>
              <div className="px-5 py-3 border-b border-white/5 flex items-center justify-between">
                <span className="text-[10px] font-black text-emerald-500/80 uppercase tracking-tighter">Technical Feedback</span>
                <button onClick={() => handleSendMessage(`'${analysis.patternAnalysisTitle}' 패턴의 기술적 완성도를 높이기 위한 오답 노트를 작성해줘.`)} className="p-1 text-slate-500 hover:text-emerald-400 transition-colors">{ICONS.Search}</button>
              </div>
              <div className="p-6">
                <h5 className="text-xl font-black text-white mb-4 leading-tight tracking-tight relative inline-block">
                  <span className="relative z-10">{analysis.patternAnalysisTitle}</span>
                  <div className="absolute bottom-1 left-0 right-0 h-3 bg-emerald-500/20 -rotate-1 z-0 rounded-full"></div>
                </h5>
                <p className="text-slate-300 leading-relaxed text-sm font-medium opacity-90">{analysis.patternAnalysis}</p>
              </div>
            </section>

            {/* Entry 4: Learning Path - Post-it style */}
            <section className="relative ml-6 mr-2 bg-blue-600/10 border-l-4 border-blue-600 p-6 rounded-r-2xl shadow-lg animate-in fade-in zoom-in-95 delay-150">
              <div className="absolute top-0 right-0 p-2 opacity-30">{ICONS.Lightbulb}</div>
              <h5 className="text-lg font-black text-white mb-3 tracking-tighter uppercase">Action Plan for Growth</h5>
              <div className="space-y-4">
                <div className="bg-white/5 p-3 rounded-xl border border-white/5">
                  <p className="text-xs font-bold text-blue-400 mb-1 leading-tight">{analysis.learningPath.title}</p>
                  <p className="text-[11px] text-slate-400 leading-relaxed">{analysis.learningPath.description}</p>
                </div>
                <div className="space-y-2">
                  {analysis.learningPath.actionItems.map((item, idx) => (
                    <div key={idx} className="flex items-center gap-3">
                      <div className="w-1.5 h-1.5 bg-blue-500 rounded-full shrink-0"></div>
                      <p className="text-xs font-bold text-slate-200">{item}</p>
                    </div>
                  ))}
                </div>
              </div>
            </section>

            {/* Highlighted Quote */}
            <div className="text-center px-4 py-6">
                <p className="text-emerald-400 text-lg font-black italic tracking-tight leading-tight">
                    "{analysis.behavioralGuide}"
                </p>
                <div className="mt-2 w-16 h-1 bg-emerald-500/30 mx-auto rounded-full"></div>
            </div>
          </div>
        )}

        {/* Chat Assistant Entries - Styled as margin notes */}
        {messages.filter(m => m.role === 'assistant').map((msg, i) => (
          <section key={i} className="ml-4 mr-2 bg-slate-800/50 border border-slate-700/50 p-5 rounded-2xl shadow-inner animate-in slide-in-from-right-4">
            <div className="flex items-center gap-2 mb-2">
                <div className="w-4 h-4 bg-blue-600 rounded flex items-center justify-center text-[8px] font-black text-white">AI</div>
                <h4 className="text-slate-400 text-[9px] font-black uppercase tracking-widest">Added Insight</h4>
            </div>
            <p className="text-slate-200 text-[13px] leading-relaxed whitespace-pre-wrap font-medium">{msg.content}</p>
          </section>
        ))}

        {/* Question Stickers */}
        {analysis && (
          <div className="flex flex-wrap gap-2 pt-6 pb-4 ml-2">
            {analysis.suggestedQuestions.map((q, i) => (
              <button key={i} onClick={() => handleSendMessage(q)} className="bg-slate-900/80 hover:bg-slate-800 text-slate-400 hover:text-white text-[10px] px-3 py-2 rounded-lg border border-slate-800 transition-all active:scale-95 shadow-sm"># {q}</button>
            ))}
          </div>
        )}
      </div>

      {/* Input - Styled as a sticky footer note bar */}
      <div className="p-4 border-t border-white/5 bg-slate-950/95 backdrop-blur-xl shrink-0 sticky bottom-0 z-30">
        <div className="flex items-center bg-white/5 rounded-2xl border border-white/10 focus-within:border-blue-500/40 transition-all px-4 py-2 shadow-2xl">
          <input 
            type="text" 
            value={input} 
            onChange={e => setInput(e.target.value)} 
            onKeyDown={e => e.key === 'Enter' && handleSendMessage()} 
            placeholder="노트에 추가 질문을 기록하세요..." 
            className="flex-1 bg-transparent border-none outline-none text-xs text-slate-100 placeholder:text-slate-600 font-medium" 
          />
          <button onClick={() => handleSendMessage()} className="ml-2 p-2 bg-blue-600 text-white rounded-xl hover:bg-blue-500 transition-all active:scale-90 shadow-lg shadow-blue-600/20">{ICONS.Send}</button>
        </div>
      </div>
    </div>
  );
};

export default App;
